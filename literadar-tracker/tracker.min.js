
(function(b,a){T={version:"0.0.1",isSmallScreen:(screen.width>500)?false:true,options:{mode:"watch",ws:"",watch:{timeout:180000,maximumAge:120000,enableHighAccuracy:true},track:{minDistance:20,multiplier:0.5}},locale:{itsmeId:"Own"},locations:[],icons:{},map:undefined};b.T=T;T.update=function(e,d){for(var c in d){if(c in e){e[c]=d[c]}}return e};T.parseOptions=function(c){T.options.mode=c.mode;T.options.ws=c.ws;if("watch" in c){var d=(c.watch+"::").split(":");if(parseInt(d[0])){this.options.watch.timeout=parseInt(d[0])*1000}if(parseFloat(d[1])){this.options.watch.maximumAge=parseFloat(d[1])*1000}if(d[2]==="t"){this.options.watch.enableHighAccuracy=true}if(d[2]==="f"){this.options.watch.enableHighAccuracy=false}}if("track" in c){var d=(c.track+":").split(":");if(parseInt(d[0])){this.options.track.minDistance=parseInt(d[0])}if(parseFloat(d[1])){this.options.track.multiplier=parseFloat(d[1])}}};T.latLng=function(c){if(Array.isArray(c.latlng)){c.latlng={lat:c.latlng[0],lng:c.latlng[1]}}else{if("latitude" in c&&"longitude" in c){c.latlng={lat:c.latitude,lng:c.longitude}}}return c};T.makeIcon=function(c,d){d=d||32;return L.icon({iconSize:[d,d],iconAnchor:[d/2,d],iconUrl:c})};T.icons.own=T.makeIcon("./images/phone_y.png");T.icons.active=T.makeIcon("./images/phone_b.png");T.WakeLocker=function(){this.wakeLock=null;if("getWakeLock" in navigator){var f=["system","screen"];for(var c=0;c<2;c++){try{this.wakeLock=navigator.getWakeLock(f[c]);break}catch(d){console.log(d.message)}}}else{console.log("WakeLock API not supported");return new NoSleep()}this.request=null;this.createRequest=function(){if(this.wakeLock&&a.visibilityState==="visible"){this.request=this.wakeLock.createRequest()}};this.handleEvent=function(g){if(g.type==="visibilitychange"||g.type==="fullscreenchange"){this.createRequest()}};this.enable=function(){a.addEventListener("visibilitychange",this);a.addEventListener("fullscreenchange",this);this.createRequest()};this.disable=function(){if(this.wakeLocker.request){a.removeEventListener("visibilitychange",this);a.removeEventListener("fullscreenchange",this);this.request.cancel()}}};T.Location=function(){this.id="";this.itsme=false;this.latlng=undefined;this.accuracy=null;this.speed=null;this.altitude=null;this.altitudeAccuracy=null;this.heading=null;this.timestamp=null;this.timeout=null};T.locationWatcher=new function(){this.watchId=undefined;this.start=function(f,d,c){if(!("geolocation" in navigator)){d({code:0,message:"Geolocaton API not supported."});return}if(this.watchId){this.stop()}this.lastLocation=undefined;this.isFree=true;this.locations=[];this.onLocationFound=f;var e=this;this.watchId=navigator.geolocation.watchPosition(function(g){if(!e.lastLocation||e.lastLocation.timestamp<g.timestamp){e.lastLocation=g;e.onLocationFound(g)}},d,c)};this.stop=function(){if(this.watchId){navigator.geolocation.clearWatch(this.watchId);this.watchId=undefined}}};T.onLocationFound=function(c){var d=new T.Location();T.update(d,T.latLng(c.coords));d.id=T.locale.itsmeId;d.itsme=true;d.timestamp=c.timestamp;d.timeout=T.options.watch.timeout;T.onLocation(d)};T.onLocationError=function(c){c.message="Geolocation: "+c.message;console.log(c.message);T.map.ui.consolePane.log(c.message)};T.onLocation=function(c){if(!this.map.isLoaded&&this.locations.length===0){this.map.setView(c.latlng,this.map.options.zoom)}if(!this.locations[c.id]){this.locations[c.id]=c}this.map.setMarker(c)};T.actions=[];T.actions.location=function(c){T.onLocation(c)};T.actions.message=function(c){T.map.ui.consolePane.log(c.message)};T.onAction=function(c){var d=T.actions[c.action];if(d){d(c)}};T.onJSONmessage=function(d){var c=JSON.parse(d);T.onAction(c)};T.checkWebSocket=function(){if(this.options.ws){var d=(b.location.protocol==="https:"?"wss://":"ws://")+this.options.ws;try{if("webSocket" in T){T.webSocket.close()}T.webSocket=new WebSocket(d);T.webSocket.onmessage=T.onJSONmessage;T.webSocket.onopen=function(f){T.sendJSONmessage=function(e){T.webSocket.send(e)};console.log("WebSocket open")};T.webSocket.onclose=function(f){console.log("WebSocket close")};T.webSocket.onerror=function(f){T.map.ui.consolePane.log(f.message);console.log(f.message)}}catch(c){console.log(c.message)}}};T.checkMode=function(c){return((new RegExp("(^|,)"+c+"(,|$)","i")).test(this.options.mode))};T.checkWatchMode=function(){if(!this.checkMode("nowatch")){this.locationWatcher.start(T.onLocationFound,T.onLocationError,T.options.watch);T.noSleep=new T.WakeLocker()}else{T.noSleep={enable:function(){},disable:function(){}}}};T.checkDemoMode=function(c){if(this.checkMode("demo")){this.demo.start(5000,c)}};T.expirationTimer;T.checkExpiredLocations=function(){if(!this.expirationTimer){this.expirationTimer=setInterval(function(){for(var c in T.locations){if(T.locations[c].timestamp+T.locations[c].timeout<Date.now()){T.map.setMarkerOpacity(T.locations[c],0.4)}}},60000)}};T.start=function(d,c,e){this.parseOptions(d);this.map=T._ui.addTo(this._map(c)).load(e);this.map.once("locationfound",function(f){T.checkDemoMode(f.latlng)});this.map.once("locationerror",function(f){T.checkDemoMode()});this.checkWebSocket();this.checkWatchMode();this.checkExpiredLocations();b.addEventListener("unload",T.stop)};T.stop=function(){T.locationWatcher.stop();if("webSocket" in T){T.webSocket.close()}clearTimeout(T.expirationTimer);T.noSleep.disable();T.demo.stop()};T._map=function(c,e){var d=L.map(c,{minZoom:8,zoom:17,zoomControl:false});L.tileLayer(b.location.protocol+"//{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(d);d.ui={};d.isLoaded=false;d.markerLayer=L.featureGroup();d.addLayer(d.markerLayer);d.accuracyLayer=L.featureGroup();d.addLayer(d.accuracyLayer);d.showAccuracy=true;d.toggleAccuracy=function(){this.showAccuracy=!this.showAccuracy;if(this.showAccuracy){if(!d.hasLayer(this.track.accuracyLayer)){this.addLayer(this.track.accuracyLayer)}this.addLayer(this.accuracyLayer)}else{if(d.hasLayer(this.track.accuracyLayer)){this.removeLayer(this.track.accuracyLayer)}this.removeLayer(this.accuracyLayer)}return this.showAccuracy};d.markers=[];d.setMarkerOpacity=function(h,g){var f=this.markers[h.id];if(f){f.setOpacity(g)}};d.setMarker=function(h,g){g=g||(h.itsme?T.icons.own:T.icons.active);var f=this.markers[h.id];if(!f){f=L.marker(h.latlng,{icon:g,alt:h.id,title:h.id});f.on("click",function(i){d.onMarkerClick(i)});f.addTo(this.markerLayer);f.accuracyCircle=L.circle(h.latlng,h.accuracy,{weight:1,color:"blue"}).addTo(this.accuracyLayer);this.markers[h.id]=f}else{f.setLatLng(h.latlng);f.accuracyCircle.setLatLng(h.latlng);f.accuracyCircle.setRadius(h.accuracy);f.setOpacity(1)}f.location=h;this.trackMarker(f);return f};d.searchMarkersById=function(h){String.prototype.replaceAll=function(l,k){return this.split(l).join(k)};h="^"+h.replaceAll("?",".{1}").replaceAll("*",".*")+"$";var g=[];try{var j=new RegExp(h,"i")}catch(i){console.log(i.message);return g}for(var f in d.markers){if(j.test(f)){g[f]=d.markers[f]}}return g};d.boundMarkers=function(){if(this.hasLayer(this.accuracyLayer)){var f=this.accuracyLayer.getBounds()}else{var f=this.markerLayer.getBounds()}this.fitBounds(f)};d.onMarkerClick=function(g){var h=g.target.options.alt;var f=this.markers[h];this.startTrack(f)};d.track={marker:undefined,pathLayer:undefined,rubberThread:undefined,accuracyLayer:L.featureGroup(),pathLength:0,lastLocation:undefined};d.track.init=function(f){if(f.hasLayer(this.accuracyLayer)){f.removeLayer(this.accuracyLayer)}if(f.hasLayer(this.pathLayer)){f.removeLayer(this.pathLayer)}if(f.hasLayer(this.rubberThread)){f.removeLayer(this.rubberThread)}this.pathLayer=L.polyline([],{weight:2,color:"red"}).addTo(f);this.rubberThread=L.polyline([],{weight:2,color:"red"}).addTo(f);this.accuracyLayer=L.featureGroup();if(f.showAccuracy){f.addLayer(this.accuracyLayer)}this.pathLength=0;this.lastLocation=undefined};d.startTrack=function(f){if(this.track.marker===f){if(f.location.itsme){T.noSleep.disable();this.ui.consolePane.log("NoSleep OFF")}this.track.marker=undefined;this.track.rubberThread.setLatLngs([])}else{if(f.location.itsme){T.noSleep.enable();this.ui.consolePane.log("NoSleep ON")}this.track.init(this);this.track.started=f.location.timestamp;if(!this.ui.infoPane){this.ui.infoPaneCtl.addTo(this)}this.track.marker=f;this.trackMarker(f)}};d.trackMarker=function(f){if(this.track.marker===f){var h=0;var g=T.options.track.minDistance;if(this.track.lastLocation){h=d.distance(f.location.latlng,this.track.lastLocation.latlng);g=Math.max(g,g*T.options.track.multiplier*h*1000/(f.location.timestamp-this.track.lastLocation.timestamp))}if(!this.track.lastLocation||h>=g){this.track.lastLocation=f.location;this.track.pathLayer.addLatLng(f.location.latlng);L.circle(f.location.latlng,f.accuracyCircle.getRadius(),{weight:1,color:"blue"}).addTo(this.track.accuracyLayer);this.track.pathLength+=h;this.track.rubberThread.setLatLngs([])}else{this.track.rubberThread.setLatLngs([this.track.lastLocation.latlng,f.location.latlng])}this.setView(f.location.latlng,this.getZoom());this.ui.infoPane.update(L.Util.extend(f.location,{trackLength:this.track.pathLength,trackTime:f.location.timestamp-this.track.started,movement:h}))}};d.load=function(f){this.once("load",function(g){d.isLoaded=true});this.on("locationfound",function(g){d.ui.consolePane.log();d.setView(g.latlng,this.options.zoom)});this.on("locationerror",function(g){this.ui.consolePane.log(g.message);console.log(g.message)});this.locateOwn(f);return this};d.locateOwn=function(f){if(f){this.setView(f,this.options.zoom)}else{this.ui.consolePane.log("Expect location...",120000);this.locate({setView:false})}return this};return d};T._ui={infoPaneCtl:new (L.Control.extend({options:{position:"bottomleft",infoData:{id:{nick:"Track: ",unit:""},trackLength:{nick:"DST",unit:"m"},trackTime:{nick:"TTM",unit:""},timestamp:{nick:"TME",unit:""},speed:{nick:"SPD",unit:"m/s"},altitude:{nick:"ALT",unit:"m"},movement:{nick:"MVT",unit:"m"},heading:{nick:"HDN",unit:"&deg"},accuracy:{nick:"ACC",unit:"m"}}},onAdd:function(f){var i=L.DomUtil.create("div","tracker-pane"),e,h,g,d;i.onclick=function(j){var k=f.ui.infoPane.getContainer();if(!k.style.marginLeft){k.style.marginLeft="-100px"}else{k.style.marginLeft=""}};d=L.DomUtil.create("div","tracker-title",i);this.options.infoData.id.element=d;e=L.DomUtil.create("table","tracker-table",i);d=L.DomUtil.create("div","tracker-title",i);d.innerHTML="Location:";h=L.DomUtil.create("table","tracker-table",i);for(var c in this.options.infoData){if(c==="id"){continue}if(c==="timestamp"){e=h}g=L.DomUtil.create("tr","tracker-row",e);d=L.DomUtil.create("td","tracker-info-nick",g);d.innerHTML=this.options.infoData[c].nick;d=L.DomUtil.create("td","tracker-info-value",g);this.options.infoData[c].element=d}f.ui.infoPane=this;return i},onRemove:function(c){delete c.ui.infoPane},update:function(e){for(var c in this.options.infoData){if(!(c in e)){continue}var d=e[c];switch(c){case"id":d=this.options.infoData[c].nick+d;break;case"timestamp":d=(new Date(d)).toTimeString().substring(0,8);break;case"trackTime":d=(new Date(d)).toISOString().substring(11,19);break;default:d=Math.round(d).toString()}this.options.infoData[c].element.innerHTML=d+" "+this.options.infoData[c].unit}}})),consolePaneCtl:new (L.Control.extend({options:{position:"bottomright",timer:null},onAdd:function(c){var d=L.DomUtil.create("div","tracker-console");d.hidden=true;c.ui.consolePane=this;return d},onRemove:function(c){delete c.ui.consolePane},log:function(c,d){var e=this.getContainer();if(c){e.innerHTML=(new Date()).toTimeString().substring(0,8)+" "+c;e.hidden=false;d=d||10000;if(this.options.timer){clearTimeout(this.options.timer)}this.options.timer=setTimeout(function(f){f.getContainer().hidden=true;f.options.timer=null},d,this)}else{e.hidden=true}}})),listPaneCtl:new (L.Control.extend({options:{position:"topright"},onAdd:function(c){var f=function(){var s=" -webkit- -moz- -o- -ms- ".split(" ");var i=function(t){return b.matchMedia(t).matches};if(("ontouchstart" in b)||b.DocumentTouch&&a instanceof DocumentTouch){return true}var r=["(",s.join("touch-enabled),("),"heartz",")"].join("");return i(r)};var e=L.DomUtil.create("div","tracker-pane"),j,q,d,l=c.searchList;e.onclick=function(r){if(r.target.tagName==="IMG"){var i=r.target.parentNode.parentNode.childNodes[2].innerHTML;c.startTrack(c.markers[i])}c.ui.listPane.remove()};var n=L.DomUtil.create("div","tracker-title",e);var k=L.DomUtil.create("div","tracker-scroll",e);var p=function(r,s){var i=((b.innerHeight||a.documentElement.clientHeight)-105)+"px";if(i!==r.style.maxHeight){r.style.maxHeight=i}};p(k,105);this.options.timer=setInterval(p,500,k,105);j=L.DomUtil.create("table","tracker-list",k);var m=f()?"tracker-button":"tracker-list";var h=0;for(var o in l){q=L.DomUtil.create("tr","tracker-list",j);d=L.DomUtil.create("td","tracker-list-img",q);var g=L.DomUtil.create("img",m,d);g.src=l[o].getIcon().options.iconUrl;h++;d=L.DomUtil.create("td","tracker-list",q);d.innerHTML=h.toString()+(c.track.marker===l[o]?"*":"");d=L.DomUtil.create("td","tracker-list-id",q);d.innerHTML=o}n.innerHTML="Found: "+h;c.ui.listPane=this;L.DomEvent.disableClickPropagation(e);L.DomEvent.disableScrollPropagation(e);return e},onRemove:function(c){delete c.ui.listPane;clearInterval(this.options.timer)}})),buttonPaneCtl:new (L.Control.extend({options:{position:"topright",buttons:{btnSearch:{img:"./images/btn_search.png",onclick:function(c){return(function(g){var f=this.getElementsByClassName("tracker-search")[0];if(!f){f=L.DomUtil.create("form","tracker-search");var d=L.DomUtil.create("input","tracker-search",f);d.type="text";d.name="searchCriteria";f.onsubmit=function(){try{c.searchList=c.searchMarkersById(this.searchCriteria.value);if(Object.keys(c.searchList).length!==0){c.ui.listPaneCtl.addTo(c)}else{c.ui.consolePane.log("Nothing found")}}catch(h){console.log(h.message)}this.parentElement.removeChild(f);return false};this.insertBefore(f,g.target);d.focus();d.scrollIntoView()}else{if(g.target!==f.searchCriteria){f.onsubmit(f)}}})}},btnAccuracy:{img:"./images/btn_accuracy.png",onclick:function(c){return(function(d){this.childNodes[1].hidden=!c.toggleAccuracy()})},checked:true},btnBound:{img:"./images/btn_bound.png",onclick:function(c){return(function(d){c.boundMarkers()})}},btnLocate:{img:"./images/btn_locate.png",onclick:function(c){return(function(d){c.locateOwn()})}}}},onAdd:function(f){var h=L.DomUtil.create("div","tracker-buttons-pane"),g,e,c;for(var d in this.options.buttons){g=L.DomUtil.create("div","tracker-button",h);e=L.DomUtil.create("img","tracker-button",g);e.src=this.options.buttons[d].img;if(this.options.buttons[d].onclick){g.onclick=this.options.buttons[d].onclick(f)}if("checked" in this.options.buttons[d]){c=L.DomUtil.create("img","tracker-button-checker",g);c.src="./images/btn_checker.png";c.hidden=!this.options.buttons[d].checked}}f.ui.buttonPane=this;L.DomEvent.disableClickPropagation(h);L.DomEvent.disableScrollPropagation(h);return h},onRemove:function(c){delete c.ui.buttonPane}})),addTo:function(c){this.buttonPaneCtl.addTo(c);this.consolePaneCtl.addTo(c);c.ui.infoPaneCtl=this.infoPaneCtl;c.ui.listPaneCtl=this.listPaneCtl;return c}};T.demo={isRunning:false,demos:[],randInt:function(d,c){if(d===c){return d}return Math.floor((Math.random()*(c-d+1))+d)},randDbl:function(d,c){if(d===c){return d}return(Math.random()*(c-d))+d},radialDistance:function(e,n,c){var f=6371010;var i=c;var m=Math.PI/180;var g=(n%360)*m;var l=e.lat*m;var j=e.lng*m;var k=Math.asin((Math.sin(l)*Math.cos(i/f))+(Math.cos(l)*Math.sin(i/f)*Math.cos(g)));var h=j+Math.atan2(Math.sin(g)*Math.sin(i/f)*Math.cos(l),Math.cos(i/f)-Math.sin(l)*Math.sin(k));return{lat:k/m,lng:((h/m)+540)%360-180}},moveRandom:function(c){c.heading=(this.randInt(c.heading-45,c.heading+45)+360)%360;var d=this.randDbl(10,50);c.latlng=this.radialDistance(c.latlng,c.heading,d);c.speed=d/((Date.now()-c.timestamp)/1000);c.accuracy=this.randDbl(5,50);c.timestamp=Date.now();return c},sendAllDemos:function(){for(var c=0;c<this.demos.length;c++){this.sendDemo(this.moveRandom(this.demos[c]))}},sendDemo:function(c){T.onJSONmessage(JSON.stringify(c))},start:function(c,f){if(this.isRunning){return}this.isRunning=true;for(var d=0;d<5;d++){var e=new T.Location();e.action="location";e.id="Demo "+(d+1);e.timeout=c;e.latlng=f?f:L.latLng(51.505,-0.09);e.heading=this.randInt(0,360);this.demos[d]=this.moveRandom(e)}this.sendAllDemos();this.timer=setInterval(function(g){g.sendAllDemos()},c,this);T.onJSONmessage(JSON.stringify({action:"message",message:"DEMO started"}))},stop:function(){if(this.timer){clearTimeout(this.timer)}}}}(window,document));